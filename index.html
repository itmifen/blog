<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>IT米粉</title>
    <meta name="author" content="[object Object]" />
    <meta name="version" content="1.0.0" />
    <meta name="keywords" content="IT米粉,架构,spring cloud,程序员,数据库" />
    <meta name="description" content="公众号：itmifen，IT狗，程序猿，苦B奋斗的伪文中老年" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
    <meta name="baidu-site-verification" content="F0CXvmUgA9" />

    
    
    <link rel="icon" href="/favicon.png">
    

    <link rel="stylesheet" href="/css/style.css">
</head>
<body>

    <div class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>

    <nav class="nav-inner">

        
        
        <li class="nav-item active">
            <a class="nav-link" href="/">首页</a>
        </li>
        
        
        
        <li class="nav-item nav-item-tag">
            <a id="nav-tag" class="nav-link" href="#">标签</a>
            <div id="nav-tags" class="nav-tag-wrap">
                <i class="nav-tag-arrow"></i>
                
  <div class="widget-wrap">
    <h3 class="widget-title">
        <i class="icon-tag vm"></i>
        <span class="vm">标签</span>
    </h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/net/">.net</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IT技术/">IT技术</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mac/">mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/其他/">其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a></li></ul>
    </div>
  </div>


            </div>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/archives">归档</a>
        </li>
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/about">关于</a>
        </li>
        
        
        

    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://www.17ij.com"></form>

        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="http://oe749te3z.bkt.clouddn.com/logo.png" title="Sanonz">
                </a>
            </div>
            
            <div class="author-name">公众号：itmifen</div>
            <div class="author-work">IT狗，程序猿，苦B奋斗的伪文中老年</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">深圳, shenzhen</span>
            </div>
            
            <div class="author-thread-wrap">
                <div class="author-threads clearfix">
                    
                    <a class="thread-item" href="https://github.com/itmifen" target="_blank" rel="noopener"><i class="icon-github"></i></a>
                    
                    
                    <a class="thread-item" href="http://m.timegoto.com/user/1" target="_blank" rel="noopener"><i class="icon-circle-more"></i></a>
                    
                    
                    <a class="thread-item" href="https://twitter.com/sanonze" target="_blank" rel="noopener"><i class="icon-twitter"></i></a>
                    
                </div>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/markdowntools/">我的Markdown的利器——Markdown Here、有道云笔记、iPic</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/markdowntools/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-05-26T22:00:00.000Z" itemprop="datePublished">2018-05-27</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/IT技术/">IT技术</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <blockquote>
<p>Markdown逐渐成为大家文章编辑的首选，这里推荐两个比较冷门的Markdown工具。  </p>
</blockquote>
        
        <p class="article-more-link">
            <a href="/markdowntools/#more">
                <span class="vm">阅读全文</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/mycat/">学会数据库读写分离、分表分库——用Mycat，这一篇就够了！</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/mycat/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-05-26T22:00:00.000Z" itemprop="datePublished">2018-05-27</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/其他/">其他</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <blockquote>
<p>系统开发中，数据库是非常重要的一个点。除了程序的本身的优化，如：SQL语句优化、代码优化，数据库的处理本身优化也是非常重要的。主从、热备、分表分库等都是系统发展迟早会遇到的技术问题问题。Mycat是一个广受好评的数据库中间件，已经在很多产品上进行使用了。希望通过这篇文章的介绍，能学会Mycat的使用。  </p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Mycat官网：<a href="http://www.mycat.io/" target="_blank" rel="noopener">http://www.mycat.io/</a><br>可以了解下Mycat的背景和应用情况，这样使用起来比较有信心。  </p>
<p>Mycat下载地址：<a href="http://www.mycat.io/" target="_blank" rel="noopener">http://dl.mycat.io/</a><br>官网有个文档，属于详细的介绍，初次入门，看起来比较花时间。</p>
<p><strong>下载：</strong><br>建议大家选择 1.6-RELEASE 版本，毕竟是比较稳定的版本。</p>
<p><strong>安装：</strong><br>根据不同的系统选择不同的版本。包括linux、windows、mac,作者考虑还是非常周全的，当然，也有源码版的。（ps:源码版的下载后，只要配置正确，就可以正常运行调试，这个赞一下。）<br><img src="https://ws3.sinaimg.cn/large/006tNc79gy1fjfersexy7j31kw0ac0zb.jpg" alt=""></p>
<p>Mycat的安装其实只要解压下载的目录就可以了，非常简单。<br>安装完成后，目录如下：</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>bin</td>
<td>mycat命令，启动、重启、停止等</td>
</tr>
<tr>
<td>catlet</td>
<td>catlet为Mycat的一个扩展功能</td>
</tr>
<tr>
<td>conf</td>
<td>Mycat 配置信息,重点关注  </td>
</tr>
<tr>
<td>lib</td>
<td>Mycat引用的jar包，Mycat是java开发的</td>
</tr>
<tr>
<td>logs</td>
<td>日志文件，包括Mycat启动的日志和运行的日志。</td>
</tr>
</tbody>
</table>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Mycat的配置文件都在conf目录里面，这里介绍几个常用的文件：</p>
<table>
<thead>
<tr>
<th>文件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>server.xml</td>
<td>Mycat的配置文件，设置账号、参数等</td>
</tr>
<tr>
<td>schema.xml</td>
<td>Mycat对应的物理数据库和数据库表的配置</td>
</tr>
<tr>
<td>rule.xml</td>
<td>Mycat分片（分库分表）规则  </td>
</tr>
</tbody>
</table>
<p>Mycat的架构其实很好理解，Mycat是代理，Mycat后面就是物理数据库。和Web服务器的Nginx类似。对于使用者来说，访问的都是Mycat，不会接触到后端的数据库。<br>我们现在做一个主从、读写分离，简单分表的示例。结构如下图：<br><img src="https://ws2.sinaimg.cn/large/006tNc79gy1fjglurmknmj30m80ipmyr.jpg" alt=""></p>
<table>
<thead>
<tr>
<th>服务器</th>
<th>IP</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mycat</td>
<td>192.168.0.2</td>
<td>mycat服务器，连接数据库时，连接此服务器</td>
</tr>
<tr>
<td>database1</td>
<td>192.168.0.3</td>
<td>物理数据库1，真正存储数据的数据库</td>
</tr>
<tr>
<td>database2</td>
<td>192.168.0.4</td>
<td>物理数据库2，真正存储数据的数据库</td>
</tr>
</tbody>
</table>
<p>Mycat作为主数据库中间件，肯定是与代码弱关联的，所以代码是不用修改的，使用Mycat后，连接数据库是不变的，默认端口是8066。连接方式和普通数据库一样，如：jdbc:mysql://192.168.0.2:8066/</p>
<p><strong>server.xml</strong></p>
<p>示例<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">"test"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span>&gt;</span>test<span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">    	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schemas"</span>&gt;</span>lunch<span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">    	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"readOnly"</span>&gt;</span>false<span class="tag">&lt;/<span class="name">property</span>&gt;</span>  </span><br><span class="line">		</span><br><span class="line">		<span class="comment">&lt;!-- 表级 DML 权限设置 --&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 		</span></span><br><span class="line"><span class="comment">		&lt;privileges check="false"&gt;</span></span><br><span class="line"><span class="comment">			&lt;schema name="TESTDB" dml="0110" &gt;</span></span><br><span class="line"><span class="comment">				&lt;table name="tb01" dml="0000"&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">				&lt;table name="tb02" dml="1111"&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">			&lt;/schema&gt;</span></span><br><span class="line"><span class="comment">		&lt;/privileges&gt;		</span></span><br><span class="line"><span class="comment">		 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">重点关注下面这段，其他默认即可。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">参数 | 说明</span><br><span class="line">---|---</span><br><span class="line">user | 用户配置节点</span><br><span class="line">--name | 登录的用户名，也就是连接Mycat的用户名</span><br><span class="line">--password | 登录的密码，也就是连接Mycat的密码</span><br><span class="line">--schemas | 数据库名，这里会和schema.xml中的配置关联，多个用逗号分开，例如需要这个用户需要管理两个数据库db1,db2，则配置db1,dbs</span><br><span class="line">--privileges | 配置用户针对表的增删改查的权限，具体见文档吧    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">我这里配置了一个账号test  密码也是test,针对数据库lunch,读写权限都有，没有针对表做任何特殊的权限。</span><br><span class="line"></span><br><span class="line">**schema.xml**  </span><br><span class="line">schema.xml是最主要的配置项，首先看我的配置文件。  </span><br><span class="line"></span><br><span class="line">```xml</span><br><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 数据库配置，与server.xml中的数据库对应 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"lunch"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"lunchmenu"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"restaurant"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"userlunch"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"users"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"dictionary"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">autoIncrement</span>=<span class="string">"true"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span>  <span class="attr">rule</span>=<span class="string">"mod-long"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 分片配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn1"</span> <span class="attr">dataHost</span>=<span class="string">"test1"</span> <span class="attr">database</span>=<span class="string">"lunch"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn2"</span> <span class="attr">dataHost</span>=<span class="string">"test2"</span> <span class="attr">database</span>=<span class="string">"lunch"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 物理数据库配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"test1"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span>  <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user();<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"192.168.0.2:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span>	</span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"test2"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span> <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user();<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostS1"</span> <span class="attr">url</span>=<span class="string">"192.168.0.3:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span>	</span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">参数 | 说明</span><br><span class="line">---|---</span><br><span class="line">schema | 数据库设置，此数据库为逻辑数据库，name与server.xml中schema对应</span><br><span class="line">dataNode | 分片信息，也就是分库相关配置</span><br><span class="line">dataHost | 物理数据库，真正存储数据的数据库</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">每个节点的属性逐一说明：  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**schema:**</span><br><span class="line"></span><br><span class="line">属性 | 说明</span><br><span class="line">---|---</span><br><span class="line">name | 逻辑数据库名，与server.xml中的schema对应</span><br><span class="line">checkSQLschema | 数据库前缀相关设置，建议看文档，这里暂时设为folse</span><br><span class="line">sqlMaxLimit | select 时默认的limit，避免查询全表 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**table:**</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">属性 | 说明</span><br><span class="line">---|---</span><br><span class="line">name | 表名，物理数据库中表名</span><br><span class="line">dataNode | 表存储到哪些节点，多个节点用逗号分隔。节点为下文dataNode设置的name</span><br><span class="line">primaryKey | 主键字段名，自动生成主键时需要设置  </span><br><span class="line">autoIncrement | 是否自增</span><br><span class="line">rule | 分片规则名，具体规则下文rule详细介绍</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**dataNode**  </span><br><span class="line"></span><br><span class="line">属性 | 说明</span><br><span class="line">---|---</span><br><span class="line">name | 节点名，与table中dataNode对应</span><br><span class="line">datahost | 物理数据库名，与datahost中name对应</span><br><span class="line">database | 物理数据库中数据库名</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**dataHost**  </span><br><span class="line"></span><br><span class="line">属性 | 说明</span><br><span class="line">---|---</span><br><span class="line">name | 物理数据库名，与dataNode中dataHost对应</span><br><span class="line">balance | 均衡负载的方式</span><br><span class="line">writeType | 写入方式</span><br><span class="line">dbType | 数据库类型 </span><br><span class="line">heartbeat | 心跳检测语句，注意语句结尾的分号要加。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 应用场景 </span><br><span class="line"></span><br><span class="line">### 数据库分表分库  </span><br><span class="line">配置如下：</span><br><span class="line">```xml</span><br><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 数据库配置，与server.xml中的数据库对应 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"lunch"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"lunchmenu"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"restaurant"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"userlunch"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"users"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"dictionary"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">autoIncrement</span>=<span class="string">"true"</span> <span class="attr">dataNode</span>=<span class="string">"dn1,dn2"</span>  <span class="attr">rule</span>=<span class="string">"mod-long"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 分片配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn1"</span> <span class="attr">dataHost</span>=<span class="string">"test1"</span> <span class="attr">database</span>=<span class="string">"lunch"</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn2"</span> <span class="attr">dataHost</span>=<span class="string">"test2"</span> <span class="attr">database</span>=<span class="string">"lunch"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 物理数据库配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"test1"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span>  <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user();<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"192.168.0.2:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span>	</span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"test2"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"0"</span> <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user();<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostS1"</span> <span class="attr">url</span>=<span class="string">"192.168.0.3:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span>	</span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">我在192.168.0.2、192.168.0.3均有数据库lunch。  </span><br><span class="line">lunchmenu、restaurant、userlunch、users这些表都只写入节点dn1，也就是192.168.0.2这个服务，而dictionary写入了dn1、dn2两个节点，也就是192.168.0.2、192.168.0.3这两台服务器。分片的规则为：mod-long。  </span><br><span class="line">主要关注rule属性，rule属性的内容来源于rule.xml这个文件，Mycat支持10种分表分库的规则，基本能满足你所需要的要求，这个必须赞一个，其他数据库中间件好像都没有这么多。  </span><br><span class="line">table中的rule属性对应的就是rule.xml文件中tableRule的name,具体有哪些分表和分库的实现，建议还是看下文档。我这里选择的mod-long就是将数据平均拆分。因为我后端是两台物理库，所以rule.xml中mod-long对应的function count为2，见下面部分代码：  </span><br><span class="line">```xml</span><br><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">"mod-long"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columns</span>&gt;</span>id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">	</span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">"mod-long"</span> <span class="attr">class</span>=<span class="string">"io.mycat.route.function.PartitionByMod"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- how many data nodes --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"count"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="数据库读写分离"><a href="#数据库读写分离" class="headerlink" title="数据库读写分离"></a>数据库读写分离</h3><p>配置如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE mycat:schema SYSTEM "schema.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">"http://io.mycat/"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 数据库配置，与server.xml中的数据库对应 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">"lunch"</span> <span class="attr">checkSQLschema</span>=<span class="string">"false"</span> <span class="attr">sqlMaxLimit</span>=<span class="string">"100"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"lunchmenu"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"restaurant"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"userlunch"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"users"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">"dictionary"</span> <span class="attr">primaryKey</span>=<span class="string">"id"</span> <span class="attr">autoIncrement</span>=<span class="string">"true"</span> <span class="attr">dataNode</span>=<span class="string">"dn1"</span>  /&gt;</span></span><br><span class="line"></span><br><span class="line">		</span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 分片配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">"dn1"</span> <span class="attr">dataHost</span>=<span class="string">"test1"</span> <span class="attr">database</span>=<span class="string">"lunch"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 物理数据库配置 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">"test1"</span> <span class="attr">maxCon</span>=<span class="string">"1000"</span> <span class="attr">minCon</span>=<span class="string">"10"</span> <span class="attr">balance</span>=<span class="string">"1"</span>  <span class="attr">writeType</span>=<span class="string">"0"</span> <span class="attr">dbType</span>=<span class="string">"mysql"</span> <span class="attr">dbDriver</span>=<span class="string">"native"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user();<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"192.168.0.2:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span>	</span><br><span class="line">		<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">"hostM1"</span> <span class="attr">url</span>=<span class="string">"192.168.0.3:3306"</span> <span class="attr">user</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span>	</span><br><span class="line">		<span class="tag">&lt;/<span class="name">readHost</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">这样的配置与前一个示例配置改动如下：  </span><br><span class="line">删除了table分配的规则,以及datanode只有一个  </span><br><span class="line">datahost也只有一台，但是writehost总添加了readhost,balance改为1，表示读写分离。</span><br><span class="line">以上配置达到的效果就是102.168.0.2为主库，192.168.0.3为从库。  </span><br><span class="line"></span><br><span class="line">注意：**Mycat主从分离只是在读的时候做了处理，写入数据的时候，只会写入到writehost，需要通过mycat的主从复制将数据复制到readhos**t，这个问题当时候我纠结了好久，数据写入writehost后，readhost一直没有数据，以为是自己配置的问题，后面才发现Mycat就没有实现主从复制的功能，毕竟数据库本身自带的这个功能才是最高效稳定的。</span><br><span class="line"></span><br><span class="line">&gt; 至于其他的场景，如同时主从和分表分库也是支持的了，只要了解这个实现以后再去修改配置，都是可以实现的。而热备及故障专业官方推荐使用haproxy配合一起使用，大家可以试试。  </span><br><span class="line"></span><br><span class="line">## 使用  </span><br><span class="line">Mycat的启动也很简单，启动命令在Bin目录：</span><br><span class="line">```shell</span><br><span class="line">##启动</span><br><span class="line">mycat start</span><br><span class="line"></span><br><span class="line">##停止</span><br><span class="line">mycat stop</span><br><span class="line"></span><br><span class="line">##重启</span><br><span class="line">mycat restart</span><br></pre></td></tr></table></figure></p>
<p>如果在启动时发现异常，在logs目录中查看日志。</p>
<ul>
<li>wrapper.log 为程序启动的日志，启动时的问题看这个</li>
<li>mycat.log 为脚本执行时的日志，SQL脚本执行报错后的具体错误内容,查看这个文件。mycat.log是最新的错误日志，历史日志会根据时间生成目录保存。</li>
</ul>
<p>mycat启动后，执行命令不成功，可能实际上配置有错误，导致后面的命令没有很好的执行。</p>
<p>Mycat带来的最大好处就是使用是完全不用修改原有代码的，在mycat通过命令启动后，你只需要将数据库连接切换到Mycat的地址就可以了。如下面就可以进行连接了：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h192.168.0.1 -P8806 -uroot -p123456</span><br></pre></td></tr></table></figure></p>
<p>连接成功后可以执行sql脚本了。<br>所以，可以直接通过sql管理工具（如：navicat、datagrip）连接，执行脚本。我一直用datagrip来进行日常简单的管理，这个很方便。</p>
<p>Mycat还有一个管理的连接，端口号是9906.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h192.168.0.1 -P9906 -uroot -p123456</span><br></pre></td></tr></table></figure></p>
<p>连接后可以根据管理命令查看Mycat的运行情况，当然，喜欢UI管理方式的人，可以安装一个Mycat-Web来进行管理，有兴趣自行搜索。  </p>
<p>简而言之，开发中使用Mycat和直接使用Mysql机会没有差别。</p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><p>使用Mycat后总会遇到一些坑，我将自己遇到的一些问题在这里列一下，希望能与大家有共鸣：</p>
<ul>
<li><p>Mycat是不是配置以后，就能完全解决分表分库和读写分离问题？<br>Mycat配合数据库本身的复制功能，可以解决读写分离的问题，但是针对分表分库的问题，不是完美的解决。或者说，至今为止，业界没有完美的解决方案。<br>分表分库写入能完美解决，但是，不能完美解决主要是联表查询的问题，Mycat支持两个表联表的查询，多余两个表的查询不支持。  其实，很多数据库中间件关于分表分库后查询的问题，都是需要自己实现的，而且节本都不支持联表查询，Mycat已经算做地非常先进了。<br>分表分库的后联表查询问题，大家通过合理数据库设计来避免。</p>
</li>
<li><p>Mycat支持哪些数据库，其他平台如 .net、PHP能用吗？<br>官方说了，支持的数据库包括MySQL、SQL Server、Oracle、DB2、PostgreSQL 等主流数据库，很赞。<br>尽量用Mysql,我试过SQL Server，会有些小问题，因为部分语法有点差异。</p>
</li>
<li><p>Mycat 非JAVA平台如 .net、PHP能用吗？<br>可以用。这一点MyCat做的也很棒。</p>
</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>《Mycat权威指南》： <a href="http://www.mycat.io/document/Mycat_V1.6.0.pdf" target="_blank" rel="noopener">http://www.mycat.io/document/Mycat_V1.6.0.pdf</a><br>官网 ：<a href="http://www.mycat.io/" target="_blank" rel="noopener">http://www.mycat.io/</a></p>
<blockquote>
<p>如果想熟练使用Mycat，建议要仔细看看官方推荐的文档，可能需要花点时间。本文只是简单的介绍下Mycat的配置，希望能快速让大家对Mycat有个认识，官方的文档理解起来也很容易，只是需要的时间更多，本文为说明的参数，请参考官方文档。</p>
</blockquote>
<hr>
<p><em>欢迎大家关注我的公众号交流、学习、第一时间获取最新的文章</em>。<br><strong><em>微信号：itmifen</em></strong></p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fje8z5at9kj30760763yz.jpg" alt=""></p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/logsystem/">系统日志管理那点事</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/logsystem/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2018-01-01T22:00:00.000Z" itemprop="datePublished">2018-01-02</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/java/">java</a>, <a class="article-tag-link" href="/tags/架构/">架构</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <blockquote>
<p>说起日志，大家都是耳熟能详的，一大堆日志插件映入眼帘，日志收集的方式也历历在目，但是，今天我们的重点不仅仅是收集日志了，今天我们主要说说怎么管理日志  </p>
</blockquote>
<h3 id="收集日志"><a href="#收集日志" class="headerlink" title="收集日志"></a>收集日志</h3><p>日志管理的第一件事，就是日志的收集。日志收集是开发者必备的技巧，不管是哪个开发语言，哪个开发平台，日志收集的插件都是有很多选择的。例如：  </p>
<p>.net 平台大家钟爱的log4net,支持多种存储方式（文件、数据库），多种格式，多种日志拆分方式。 </p>
<p>java 平台主流的log4j、slf4j、logback，多种选择。</p>
<p>日志收集的组件这里就不一一说明了，使用都是很简单的，这里重点说明一下，日志我们收集应该注意的地方：  </p>
<h5 id="1-日志等级一定要规范"><a href="#1-日志等级一定要规范" class="headerlink" title="1. 日志等级一定要规范"></a>1. 日志等级一定要规范</h5><table>
<thead>
<tr>
<th>等级</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>debug</td>
<td>调试信息 </td>
</tr>
<tr>
<td>info</td>
<td>用来收集关注的信息</td>
</tr>
<tr>
<td>warn</td>
<td>警告信息</td>
</tr>
<tr>
<td>error</td>
<td>错误信息  </td>
</tr>
</tbody>
</table>
<p>好多开发工程师记录日志总是喜欢用info级别来记录日志，一般的组件默认级别都是info,所有info默认都是会被记录的，而debug信息发布后，是不会被记录的。这是一种偷懒的做法，但这也是很普遍的做法。正确的方式应该根据日志本身的特性去设置日志的级别，其实规范的日志级别是非常重要的：  </p>
<ul>
<li>正确的级别便于运维。便于统一调整系统日志级别，如特殊情况可以只记录error错误</li>
<li>没有正确的级别，对后期日志分析和处理是留下很大的隐患。error是需要去关注，并且处理掉的问题。info是普通日志的记录，大部分时候是无需关注的。<h5 id="2-error日志内容一定要详实-info日志要简洁易懂"><a href="#2-error日志内容一定要详实-info日志要简洁易懂" class="headerlink" title="2. error日志内容一定要详实 ,info日志要简洁易懂"></a>2. error日志内容一定要详实 ,info日志要简洁易懂</h5>运营过大型系统的人都知道，除了数据库存储外，日志、图片、附件是存储的三大债主，他们是会占用非常非常大的空间，所有记录info的日志，要简洁易懂，避免空间浪费。<br>而对于error级别的错误，记录一定要详实，因为error的所有问题，是后期都要去解决的。</li>
<li>请求的地址</li>
<li>请求的参数</li>
<li>请求的ip</li>
<li>请求的用户</li>
<li>error具体信息</li>
<li>输出的内容</li>
<li>……  </li>
</ul>
<p>为了能很好的反馈当时error产生场景，以上的这些内容都应该被记录，而且越详细越好。  </p>
<h5 id="3-error日志一定是全局统一收集的"><a href="#3-error日志一定是全局统一收集的" class="headerlink" title="3. error日志一定是全局统一收集的"></a>3. error日志一定是全局统一收集的</h5><p>前文说过，error的日志，不仅是我们需要关注的，还是我需要解决掉的问题，所有error日志非常重要。错误日志的收集，必须是全局统一收集的，AOP是你最好的伙伴，如果你发现你的errorr日志收集是在每个类中，到处是  </p>
<pre><code class="java"><span class="keyword">try</span>
{
......
}
<span class="keyword">catch</span>()
{
    log.error(<span class="string">"......"</span>)
}
</code></pre>
<p>这个一定要避免，不管你用那种语言，错误的处理，都是可以通过全局进行统一的处理，错误日志也要通过全局统一收集。   </p>
<h3 id="管理日志"><a href="#管理日志" class="headerlink" title="管理日志"></a>管理日志</h3><p>每个开发人员对日志的收集，都是非常熟悉的，基本都是将日志按照日期的方式进行保存，日常使用日志的时候，也是有一些要求：  </p>
<h5 id="1-单个文件的大小要控制"><a href="#1-单个文件的大小要控制" class="headerlink" title="1. 单个文件的大小要控制"></a>1. 单个文件的大小要控制</h5><p>因为大家都是通过日期方式保存的，但是因为有的人不重视日志，经常会看到有的系统单个日志文件上百M，有的甚至是几G，而实际大家处理问题关注的都是最近的日志，所以控制单个日志文件的大小，对日志的性能以及后期的运维都是非常便利的。</p>
<h5 id="2-日志要便于浏览"><a href="#2-日志要便于浏览" class="headerlink" title="2. 日志要便于浏览"></a>2. 日志要便于浏览</h5><p>日志文件小才便于浏览，日志最好能通过网址直接访问到，而不需要一波三折登录服务器，花10分钟下载下来，再来分析。</p>
<h6 id="3-日志的安全性要得到保障"><a href="#3-日志的安全性要得到保障" class="headerlink" title="3. 日志的安全性要得到保障"></a>3. 日志的安全性要得到保障</h6><p>日志内容有时会包含敏感信息，特别是error日志，直接把系统的具体错误抛出来，所以日志除了查看方便，还需要确保日志文件的安全。如果是日志文件是html或者txt，请一定记得把你的日志文件权限修改下，特定用户才能访问，不要随便开放，所有人都能访问。  </p>
<h6 id="4-日志要定期清理"><a href="#4-日志要定期清理" class="headerlink" title="4. 日志要定期清理"></a>4. 日志要定期清理</h6><p>日志是非常占用存储的空间，日志太大对存储的性能也有一定的影响，所有日志要定期进行清理。  </p>
<ul>
<li>空间充足可以保留半年</li>
<li>空间不足最少也要保留3个月  </li>
</ul>
<p>当然，这个也不是一定的，根据每个系统的情况去制定清理计划就可以了。</p>
<p>如果大家是小型网站，一个系统一台服务器，日志管理就简单了。如果系统是做了高可用，后端用了均衡负载，那么，日志存在当前服务器是不太明智的做法，日志一定要统一存储，因为均衡负载随时都可能会切换服务器，当出现故障，你需要去找日志究竟存在哪个服务器，也是件很浪费时间的事情。日志文件也可以通过：</p>
<ul>
<li>共享虚拟目录来存储</li>
<li>定时进行文件同步来存储<br>日志存储也是对性能有一定影响的，文件同步虽然看起来麻烦一定，但是比共享虚拟目录的方式来说，性能会好，推荐使用这种方式。</li>
</ul>
<p>说到日志的同步，就不得不提Logstash这个日志组件。Logstash是现在应用最广的日志收集组件，基于java平台。其实很多java平台的组件，是不用去了解java开发的，只要简单的配置就能使用。  </p>
<p>Logstash支持文件同步，也可以结合rsyslog进行文件同步，当然，也支持通过tcp协议，与第三方对接，好伙伴当然是Elasticsearch。Elasticsearch下文也会做简单的介绍。  </p>
<p><strong>Logstash中文手册：<a href="https://kibana.logstash.es/content/logstash/" target="_blank" rel="noopener">点击这里</a></strong></p>
<h3 id="分析日志"><a href="#分析日志" class="headerlink" title="分析日志"></a>分析日志</h3><p>日志的分析也是一个很大的概念，可能对于运维和安全人员关注的是系统的所有日志，包括访问日志、系统监测的日志等，但是开发人员对于日志更多的是：  </p>
<ul>
<li>监控系统运行错误，并获取错误时的相关数据包  </li>
<li>记录重要的信息，某些时候便于后期检查 </li>
</ul>
<p>所以，开发人员对日志的需求相对而言简单一点，但是处理不当也会面临挑战。如果要根据某些关键字找日志，没有一个靠谱的系统处理，那么大家只能一直在ctrl+f 或者 find 命令中来回查找自己需要的信息，使用过的人都知道，这绝对不是一个很好的体验。那么是否有很好的工具来处理呢？有，这里就介绍另外的两个工具：</p>
<ul>
<li>Elasticsearch——一个基于lucene的搜索引擎工具，解决日志的搜索问题。当然，也能解决系统的搜索问题，而且是分布式的哦。</li>
<li>Kibana——一个可视化的日志操作引擎，结合Elasticsearch可以达到更好的效果。  </li>
</ul>
<p><strong>Kibana 界面预览</strong><br><img src="https://ws3.sinaimg.cn/large/006tKfTcgy1fjbxy25lm9j31kw0vih3g.jpg" alt="Kibana 界面预览">  </p>
<p>Elasticsearch+Logstash+Kibana 就是传说中的ELK了，应该是现在最流行的日志处理平台。</p>
<p><strong>Elasticsearch中文文档：<a href="http://www.learnes.net/" target="_blank" rel="noopener">点击这里</a></strong><br><strong>ELK中文文档：<a href="https://www.gitbook.com/book/chenryn/elk-stack-guide-cn/details" target="_blank" rel="noopener">点击这里</a></strong></p>
<h3 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h3><p>前文介绍日志收集、日志管理注意的事项，推荐了日志分析中两个比较简单常用的工具，这里简单说明一下，自己心目中的日志管理系统。<br>整体流程如图：  </p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcgy1fjbxbg3cnlj31120sqabq.jpg" alt="">  </p>
<p>推荐的几个工具虽然是java平台的工具，但是日志处理的思路不管是哪个平台都是一样的。ELK如果只是作为日志管理的工具，也可以应用到.net平台，无需再进行二次开发就可以很好的使用。ELK的使用是有一定的学习成本的，如有时间可以另起一文探讨，但是，这个学习成本是可以忽略语言之间的差异。<br>当然，如果大家愿意使用脚本同步或者rsyn文件同步进行日志处理也是可以的。</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/coder/">程序员也是弱势群体？——从WePhone开发者事件说起</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/coder/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-12-31T22:00:00.000Z" itemprop="datePublished">2018-01-01</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/其他/">其他</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <blockquote>
<p>作为一名不爱凑热闹的人，今天一直在持续关注一个热点事件——WePhone开发者自杀，即使前几天热议的孕妇跳楼新闻我都不太关注，但是这个事件却让我深深的震撼，花了几个小时在微博上搜索了相关的信息，去了解事情的始末，也去看了网络上对此事件的一些评判，太多的杂音让个人的产生一些想法和大家一起探讨。  </p>
</blockquote>
<h2 id="事件始末"><a href="#事件始末" class="headerlink" title="事件始末"></a>事件始末</h2><p>可能大家不是都了解事情的始末，我这里简单介绍下：</p>
<p>WePhone的开发者苏享茂在北京跳楼自杀，原因是其无法忍受其前妻敲诈勒索以及骚扰。而其前妻与其结婚只有一个月，是通过世纪佳缘网认识，结婚前后苏享茂在其妻身上花了几百万费用，而近期因与苏享茂离婚，要求苏享茂赔偿1000W以及其他相关财务，并对苏享茂进行威胁、敲诈，声称WePhone存在偷税漏税，WePhone是灰色产业，不仅可以让苏享茂家财散尽，还能让苏享茂蹲监狱，苏享茂不堪其骚然威胁，最终选择跳楼。  </p>
<p>事件详情<a href="http://www.sohu.com/a/190786356_114760/" target="_blank" rel="noopener">：传WePhone创始人自杀，去世前称被前妻勒索1000万</a>  </p>
<p>其实仔细去了解事件过程，以及通过相关知情人士和受害者朋友的介绍，基本情况就是：  </p>
<p>1、受害者通过世纪佳缘找到的老婆，应该是有预谋的骗财<br>2、受害者因各方面原因导致无法承受威胁以及压力自杀 </p>
<h2 id="程序员是弱势群体吗？"><a href="#程序员是弱势群体吗？" class="headerlink" title="程序员是弱势群体吗？"></a>程序员是弱势群体吗？</h2><p>这其实是一个很难回答的问题，弱势其实是一个相对的词语。不同的对比对象，不同的人得出的结论不一样，但是作为一名技术研究工作者，程序员的确有很明显的强弱项：   </p>
<ul>
<li>如果算收入，那么程序员肯定不是弱者。  </li>
<li>如果算智商，那么程序员肯定不是弱者。  </li>
<li>如果算人际交往，那么就有很多程序员的确不太擅长。  </li>
<li>如果厚黑学也算一种能力，那么绝大多少的程序员就是明显弱者。<br>……</li>
</ul>
<p>很多时候不得不承认，作为程序员的我们，很多方面我们都有明显的缺点，以下这些我相信大部分人中会占据一些：  </p>
<ul>
<li>人际交往能力差    </li>
<li>知识涉猎范围广  </li>
<li>性格内向  </li>
<li>清高  </li>
<li>自傲  </li>
</ul>
<p>即使我们有再高的智商，再强的逻辑思维能力，但是当我们成为坏人的猎物的时候，其实我们也是很弱小的。我们应该尽量去认识自己，去克服自己认为会影响到自己发展的缺点。  </p>
<h2 id="我们该怎么做？"><a href="#我们该怎么做？" class="headerlink" title="我们该怎么做？"></a>我们该怎么做？</h2><p>程序员绝对不是能力的弱者，技能的弱者，如果我们是弱者，我们只可能是心灵的弱者，我们要提高自己心灵的等级：</p>
<ol>
<li>认识自己  </li>
</ol>
<p>程序员要经常去思考除了代码和技术之外的东西，不要让自己一值沉醉在技术的氛围里，多去思考和关心下其他的东西，不只要总结自己技术的不足，还要总结自己生活的不足和性格的不足。只有认识了自己才能改进。  </p>
<ol start="2">
<li>走出去  </li>
</ol>
<p>很多时候和其他同事或者朋友吃饭聊天时，发现有的人不管天文地理、明星运动都能聊的很起劲，而咱们很多时候插不上话，其实除了是因为咱们不愿意说一些无用的废话以外，是否也可能是因为自己了解的东西太少。多接触不同行业的人，多经历一些不同的事情，多认识一些朋友，比每天宅在家里好得多。  </p>
<ol start="3">
<li>学习更广泛的知识   </li>
</ol>
<p>不要每天抱着《javascript从入门到放弃》《C#高级编程到颈椎病治疗》，我们也可以看看历史、看看小说、甚至看看法律、财务，真的是有用的。</p>
<ol start="4">
<li>学会减压，学会享受   </li>
</ol>
<p>提高技能的同时，也要提高生活的品质，少做一下无效的工作，不要迷恋加班，学会享受生活，多余身边的交流谈心，及时调整心态。  </p>
<h2 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h2><p>网上还听到很多人对此事件谩骂和鄙视的态度，说受害者太笨、活该等恶劣的语言。作为旁观者，可能我们看的比较清楚，如果事情真的是和自己有关，自己是不是真的也能处理的很好。想想自己在工作的时候是不是也被人利用过，也有背黑锅的时候，当时自己也是完全有能力避免，但当时没有处理好。  </p>
<p>事情迟早会过去的，希望事件最终能有个相对好的处理结果，让逝者能安息。  </p>
<p>我们作为旁观者，也要自我反省下，社会永远比程序要来的复杂，我们能搞定程序的BUG，但无法解决生活工作中太多的问题。</p>
<hr>
<p><em>欢迎大家关注我的公众号交流、学习、第一时间获取最新的文章</em>。<br><strong><em>微信号：itmifen</em></strong></p>
<p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1fje8z5at9kj30760763yz.jpg" alt=""></p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/sqlper/">SQL Server 性能查看</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/sqlper/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-12-31T22:00:00.000Z" itemprop="datePublished">2018-01-01</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/数据库/">数据库</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h4 id="执行最慢的SQL语句"><a href="#执行最慢的SQL语句" class="headerlink" title="执行最慢的SQL语句"></a>执行最慢的SQL语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">(total_elapsed_time / execution_count)/<span class="number">1000</span> N<span class="string">'平均时间ms'</span></span><br><span class="line">,total_elapsed_time/<span class="number">1000</span> N<span class="string">'总花费时间ms'</span></span><br><span class="line">,total_worker_time/<span class="number">1000</span> N<span class="string">'所用的CPU总时间ms'</span></span><br><span class="line">,total_physical_reads N<span class="string">'物理读取总次数'</span></span><br><span class="line">,total_logical_reads/execution_count N<span class="string">'每次逻辑读次数'</span></span><br><span class="line">,total_logical_reads N<span class="string">'逻辑读取总次数'</span></span><br><span class="line">,total_logical_writes N<span class="string">'逻辑写入总次数'</span></span><br><span class="line">,execution_count N<span class="string">'执行次数'</span></span><br><span class="line">,<span class="keyword">SUBSTRING</span>(st.text, (qs.statement_start_offset/<span class="number">2</span>) + <span class="number">1</span>,</span><br><span class="line">((<span class="keyword">CASE</span> statement_end_offset</span><br><span class="line"><span class="keyword">WHEN</span> <span class="number">-1</span> <span class="keyword">THEN</span> <span class="keyword">DATALENGTH</span>(st.text)</span><br><span class="line"><span class="keyword">ELSE</span> qs.statement_end_offset <span class="keyword">END</span></span><br><span class="line">- qs.statement_start_offset)/<span class="number">2</span>) + <span class="number">1</span>) N<span class="string">'执行语句'</span></span><br><span class="line">,creation_time N<span class="string">'语句编译时间'</span></span><br><span class="line">,last_execution_time N<span class="string">'上次执行时间'</span></span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">sys.dm_exec_query_stats <span class="keyword">AS</span> qs <span class="keyword">CROSS</span> <span class="keyword">APPLY</span> sys.dm_exec_sql_text(qs.sql_handle) st</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line"><span class="keyword">SUBSTRING</span>(st.text, (qs.statement_start_offset/<span class="number">2</span>) + <span class="number">1</span>,</span><br><span class="line">((<span class="keyword">CASE</span> statement_end_offset</span><br><span class="line"><span class="keyword">WHEN</span> <span class="number">-1</span> <span class="keyword">THEN</span> <span class="keyword">DATALENGTH</span>(st.text)</span><br><span class="line"><span class="keyword">ELSE</span> qs.statement_end_offset <span class="keyword">END</span></span><br><span class="line">- qs.statement_start_offset)/<span class="number">2</span>) + <span class="number">1</span>) <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">'�tch%'</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">total_elapsed_time / execution_count <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>
<h4 id="总耗CPU最多的前个SQL"><a href="#总耗CPU最多的前个SQL" class="headerlink" title="总耗CPU最多的前个SQL"></a>总耗CPU最多的前个SQL</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TOP <span class="number">20</span></span><br><span class="line">    total_worker_time/<span class="number">1000</span> <span class="keyword">AS</span> [总消耗CPU 时间(ms)],execution_count [运行次数],</span><br><span class="line">    qs.total_worker_time/qs.execution_count/<span class="number">1000</span> <span class="keyword">AS</span> [平均消耗CPU 时间(ms)],</span><br><span class="line">    last_execution_time <span class="keyword">AS</span> [最后一次执行时间],max_worker_time /<span class="number">1000</span> <span class="keyword">AS</span> [最大执行时间(ms)],</span><br><span class="line">    <span class="keyword">SUBSTRING</span>(qt.text,qs.statement_start_offset/<span class="number">2</span>+<span class="number">1</span>, </span><br><span class="line">        (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> qs.statement_end_offset = <span class="number">-1</span> </span><br><span class="line">        <span class="keyword">THEN</span> <span class="keyword">DATALENGTH</span>(qt.text) </span><br><span class="line">        <span class="keyword">ELSE</span> qs.statement_end_offset <span class="keyword">END</span> -qs.statement_start_offset)/<span class="number">2</span> + <span class="number">1</span>) </span><br><span class="line">    <span class="keyword">AS</span> [使用CPU的语法], qt.text [完整语法],</span><br><span class="line">    qt.dbid, dbname=db_name(qt.dbid),</span><br><span class="line">    qt.objectid,object_name(qt.objectid,qt.dbid) ObjectName</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_exec_query_stats qs <span class="keyword">WITH</span>(nolock)</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">apply</span> sys.dm_exec_sql_text(qs.sql_handle) <span class="keyword">AS</span> qt</span><br><span class="line"><span class="keyword">WHERE</span> execution_count&gt;<span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span>  total_worker_time <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>
<h4 id="平均耗CPU最多的前个SQL"><a href="#平均耗CPU最多的前个SQL" class="headerlink" title="平均耗CPU最多的前个SQL"></a>平均耗CPU最多的前个SQL</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TOP <span class="number">20</span></span><br><span class="line">    total_worker_time/<span class="number">1000</span> <span class="keyword">AS</span> [总消耗CPU 时间(ms)],execution_count [运行次数],</span><br><span class="line">    qs.total_worker_time/qs.execution_count/<span class="number">1000</span> <span class="keyword">AS</span> [平均消耗CPU 时间(ms)],</span><br><span class="line">    last_execution_time <span class="keyword">AS</span> [最后一次执行时间],min_worker_time /<span class="number">1000</span> <span class="keyword">AS</span> [最小执行时间(ms)],</span><br><span class="line">    max_worker_time /<span class="number">1000</span> <span class="keyword">AS</span> [最大执行时间(ms)],</span><br><span class="line">    <span class="keyword">SUBSTRING</span>(qt.text,qs.statement_start_offset/<span class="number">2</span>+<span class="number">1</span>, </span><br><span class="line">        (<span class="keyword">CASE</span> <span class="keyword">WHEN</span> qs.statement_end_offset = <span class="number">-1</span> </span><br><span class="line">        <span class="keyword">THEN</span> <span class="keyword">DATALENGTH</span>(qt.text) </span><br><span class="line">        <span class="keyword">ELSE</span> qs.statement_end_offset <span class="keyword">END</span> -qs.statement_start_offset)/<span class="number">2</span> + <span class="number">1</span>) </span><br><span class="line">    <span class="keyword">AS</span> [使用CPU的语法], qt.text [完整语法],</span><br><span class="line">    qt.dbid, dbname=db_name(qt.dbid),</span><br><span class="line">    qt.objectid,object_name(qt.objectid,qt.dbid) ObjectName</span><br><span class="line"><span class="keyword">FROM</span> sys.dm_exec_query_stats qs <span class="keyword">WITH</span>(nolock)</span><br><span class="line"><span class="keyword">CROSS</span> <span class="keyword">apply</span> sys.dm_exec_sql_text(qs.sql_handle) <span class="keyword">AS</span> qt</span><br><span class="line"><span class="keyword">WHERE</span>  execution_count&gt;<span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (qs.total_worker_time/qs.execution_count/<span class="number">1000</span>) <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/tomcatidea/">Tomcat多站点部署及集成到IntelliJ IDEA</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/tomcatidea/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-09-30T22:00:00.000Z" itemprop="datePublished">2017-10-01</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/java/">java</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <blockquote>
<p>Tomcat是Java最常用的Web容器，作为服务端部署的一款轻量级工具，使用非常广泛，这里了简单记录下Tomcat的基础是的使用。<br>Tomcat的安装和使用就不赘述了，网上很多教程，主要介绍下： </p>
<ol>
<li>如何通过Tomcat进行多站点的部署 </li>
<li>如何在IntelliJ IDEA中集成Tomcat </li>
</ol>
</blockquote>
<h5 id="Tomcat多站点部署"><a href="#Tomcat多站点部署" class="headerlink" title="Tomcat多站点部署"></a>Tomcat多站点部署</h5><p>Tomcat的目录机构主要包括:<br>| 目录或文件        | 说明          |<br>| —————– |:————-:|<br>| bin      | 运行命令的目录  |<br>| conf      | 配置文件目录       |<br>| lib  | 自带的库文件      |<br>| logs  | 日志目录      |<br>| webapps  | 默认站点      | </p>
<p>进行多站点部署主要是修改conf目录中的server.xml文件，此文件是Tomcat的配置文件。<br>Tomcat安装时候，已经包括设置好默认的站点，主要内容如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8608"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">"8443"</span>  <span class="attr">maxThreads</span>=<span class="string">"800"</span> <span class="attr">acceptCount</span>=<span class="string">"1000"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8609"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line">```  </span><br><span class="line">| 标签        | 说明          |</span><br><span class="line">| ----------------- |:-------------:| </span><br><span class="line">| Service      | 服务，类似于IIS中的线程池  | </span><br><span class="line">| Connector      | 服务配置项，优化时调整的主要方向       | </span><br><span class="line">| Host  | 设置      |  </span><br><span class="line">| Context  | 虚拟目录      | </span><br><span class="line">1. 如果需要增加虚拟目录，只要增加Context即可。  </span><br><span class="line">2. 如果需要增加相同端口，不同的主机头，则需要增加Host。  </span><br><span class="line">3. 如果需要增加不同端口，则需要增加Service。  </span><br><span class="line">##### 几个遇到的坑，需要注意：</span><br><span class="line">* 设置虚拟目录时，如果不是war文件，而是目录，设需要设置如: </span><br><span class="line">```xml</span><br><span class="line">docBase="/Users/joylee/workfile/</span><br></pre></td></tr></table></figure></p>
<p>而不能设置为:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docBase="/Users/joylee/workfile</span><br></pre></td></tr></table></figure></p>
<p>否则，Tomcat启动了也会有问题，无法运行。  </p>
<ul>
<li>如果没有appBase，可以留空，不要随便设置，否则也会导致网站无法打开。  </li>
</ul>
<h5 id="IntelliJ-IDEA集成Tomcat"><a href="#IntelliJ-IDEA集成Tomcat" class="headerlink" title="IntelliJ IDEA集成Tomcat"></a>IntelliJ IDEA集成Tomcat</h5><p>IntelliJ IDEA（下文简称IDEA） 默认集成Tomcat插件，无需另外安装,可以直接配置。具体配置步骤如下。</p>
<ol>
<li>打开服务端配置项:<br><img src="http://ww2.sinaimg.cn/large/006tNc79gw1fbl9wacjgrj30u205i3z9.jpg" alt="image"></li>
</ol>
<p><img src="http://ww1.sinaimg.cn/large/006tNc79gw1fbl9xtu5xpj319w0rkn0r.jpg" alt="image">  </p>
<ol start="2">
<li>设置Tomcat相关信息<br><img src="http://ww1.sinaimg.cn/large/006tNc79jw1fbl9yqkhhwj316k12a7a5.jpg" alt="image"></li>
</ol>
<p>设置地址、端口号、JMX Port,<br>同时需要设置war包的目录，因为Tomcat的运行只能基于War包，无法基于Jar包，如果将项目打包，就需要打包成War包。<br>3.打包设置<br><img src="http://ww2.sinaimg.cn/large/006tNc79jw1fbla3bubdhj31ji0l241e.jpg" alt="image"><br><img src="http://ww1.sinaimg.cn/large/006tNc79gw1fbla93gdyej31jw0kgq6k.jpg" alt="image"><br>配置完成后，直接运行就好了。</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/macdotnet/">Mac上开发.Net遇到的坑</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/macdotnet/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-05-26T22:00:00.000Z" itemprop="datePublished">2017-05-27</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/net/">.net</a>, <a class="article-tag-link" href="/tags/mac/">mac</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <blockquote>
<p>相信很多朋友都和我一样，使用Mac做为自己的电脑，但是工作中却需要使用.Net的开发环境，但是Mac对于.Net的支持却一直不是很好，时代在发展，微软都成为Github贡献最多的企业，那么Mac中顺利开发.Net的梦想能实现吗？  </p>
</blockquote>
        
        <p class="article-more-link">
            <a href="/macdotnet/#more">
                <span class="vm">阅读全文</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/reactnative/">React Native 常见问题</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/reactnative/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2017-05-25T22:00:00.000Z" itemprop="datePublished">2017-05-26</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/tags/前端/">前端</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <blockquote>
<p>React Native开发逐渐更多的被应用到实际的开发过程中，以后会有越来越的应用使用React Native相关技术，关于使用过程中的问题，可以在<a href="http://reactnative.cn/" target="_blank" rel="noopener">http://reactnative.cn/</a> 以及搜索引擎找到，这里补充下自己开发过程中出现的几个问题，而不容易找到解决方案的。  </p>
</blockquote>
        
        <p class="article-more-link">
            <a href="/reactnative/#more">
                <span class="vm">阅读全文</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/about/">关于我</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="/about/">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2016-05-26T22:00:00.000Z" itemprop="datePublished">2016-05-27</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>首先表示，这个名字和小米没有任何关系，纯属巧合。  </p>
<p>为什么取名叫IT米粉？其实是因为老家是在一个N线城市的小镇，镇上有种米粉，非常非常细，入口即化，汤料非常鲜，在附近非常出名，非常有名气。可是，在其他地方，特别是在一线城市，却基本看不到这样的米粉和店。一个让人赞不绝口的好东西，却不能走出去，给大家分享，实在是一件非常可惜的事情。</p>
        
        <p class="article-more-link">
            <a href="/about/#more">
                <span class="vm">阅读全文</span>
                <i class="icon-arrow-double-right vm"></i>    
            </a>
        </p>
        
        
    </section>
</article>





</div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>
</footer>


    </div>

    <script type="text/javascript" src="https://cdn.bootcss.com/jquery/1.9.0/jquery.min.js"></script>
    
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');console.log(nodes.navTags.attr('class'))
            })/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/

            
        });
    </script>

</body>
</html>
